{% extends "base.html" %}

{% block title %}Companies - Financial Risk Assessment Platform{% endblock %}

{% block extra_css %}
<style>
        :root {
            --primary-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #06b6d4;
            --dark-color: #1f2937;
            --light-color: #f8fafc;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 0;
            margin: 0;
        }

        .navbar {
        background: linear-gradient(135deg, #059669, #3b82f6) !important;
    }
    .navbar-brand, .nav-link {
        color: white !important;
    }

        .navbar-brand {
            font-weight: 700;
            color: var(--primary-color) !important;
            font-size: 1.5rem;
        }

        .main-container {
            max-width: 1600px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .page-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #1e40af 100%);
            color: white;
            padding: 2rem;
            border-radius: 20px;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .floating-particles {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 1;
        }

        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.7; }
            50% { transform: translateY(-20px) rotate(180deg); opacity: 1; }
        }

        .company-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            border-radius: 15px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .company-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
        }

        .company-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color) 0%, #1e40af 100%);
            transition: all 0.3s ease;
        }

        .company-card:hover::before {
            width: 6px;
        }

        .company-logo {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--primary-color) 0%, #1e40af 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .search-container {
            position: relative;
            margin-bottom: 2rem;
        }

        .search-input {
            border-radius: 15px;
            border: 2px solid #e2e8f0;
            padding: 1rem 3rem 1rem 1.5rem;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            width: 100%;
        }

        .search-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 1.5rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-color) 0%, #1e40af 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .companies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 1.5rem;
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fef2f2;
            color: #dc2626;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            border: 1px solid #fecaca;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #6b7280;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .action-btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 0.25rem;
        }

        .btn-view {
            background: linear-gradient(135deg, var(--primary-color) 0%, #1e40af 100%);
            color: white;
        }

        .btn-view:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            color: white;
        }

        .btn-analyze {
            background: linear-gradient(135deg, var(--info-color) 0%, #0891b2 100%);
            color: white;
        }

        .btn-analyze:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
            color: white;
        }

        .financial-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .status-excellent {
            color: #059669;
        }

        .status-good {
            color: #0891b2;
        }

        .status-moderate {
            color: #d97706;
        }

        .status-poor {
            color: #dc2626;
        }

        .metric-badge {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            color: var(--primary-color);
            padding: 0.5rem 1rem;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.875rem;
            border: 1px solid #bfdbfe;
            text-align: center;
        }

        .add-company-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--success-color) 0%, #047857 100%);
            color: white;
            border: none;
            font-size: 1.5rem;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .add-company-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 30px rgba(16, 185, 129, 0.4);
            color: white;
        }

        .filter-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .filter-tab {
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            border: 2px solid #e2e8f0;
            background: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-tab.active {
            background: linear-gradient(135deg, var(--primary-color) 0%, #1e40af 100%);
            color: white;
            border-color: var(--primary-color);
        }

        .filter-tab:hover:not(.active) {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
    </style>
{% endblock %}

{% block content %}

    <!-- Main Container -->
    <div class="main-container" style="margin-top: 80px;">
        <!-- Page Header -->
        <div class="page-header">
            <div class="floating-particles">
                <div class="particle" style="left: 10%; width: 8px; height: 8px; animation-delay: 0s;"></div>
                <div class="particle" style="left: 25%; width: 12px; height: 12px; animation-delay: 1s;"></div>
                <div class="particle" style="left: 50%; width: 6px; height: 6px; animation-delay: 2s;"></div>
                <div class="particle" style="left: 75%; width: 10px; height: 10px; animation-delay: 3s;"></div>
                <div class="particle" style="left: 90%; width: 8px; height: 8px; animation-delay: 4s;"></div>
            </div>
            
            <div class="row align-items-center position-relative" style="z-index: 2;">
                <div class="col-lg-8">
                    <h1 class="display-5 fw-bold mb-3">
                        <i class="fas fa-building me-3"></i>
                        Company Portfolio Management
                    </h1>
                    <p class="lead mb-0 opacity-90">
                        Monitor financial health and predict liquidation risks across your company portfolio
                    </p>
                </div>
                <div class="col-lg-4 text-end">
                    <button class="btn btn-light btn-lg me-3" onclick="exportPortfolioData()">
                        <i class="fas fa-download me-2"></i>Export Portfolio
                    </button>
                    <button class="btn btn-outline-light btn-lg" onclick="showPortfolioAnalytics()">
                        <i class="fas fa-chart-pie me-2"></i>Portfolio Analytics
                    </button>
                </div>
            </div>
        </div>

        <!-- Statistics Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalCompanies">0</div>
                <div class="stat-label">Total Companies</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="healthyCompanies">0</div>
                <div class="stat-label">Healthy Companies</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="riskCompanies">0</div>
                <div class="stat-label">At-Risk Companies</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgHealthScore">0.0</div>
                <div class="stat-label">Avg Health Score</div>
            </div>
        </div>

        <!-- Search and Filters -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="search-container">
                    <input type="text" class="search-input" id="searchCompanies" 
                           placeholder="Search companies by name, industry, or financial status...">
                    <i class="fas fa-search search-icon"></i>
                </div>
            </div>
            <div class="col-lg-4">
                <select class="form-select search-input" id="sortCompanies">
                    <option value="name">Sort by Name</option>
                    <option value="cash_flow">Sort by Operating Cash Flow</option>
                    <option value="net_income">Sort by Net Income</option>
                    <option value="revenue">Sort by Revenue</option>
                </select>
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="filter-tabs">
            <div class="filter-tab active" onclick="filterCompanies('all')">
                <i class="fas fa-globe me-2"></i>All Companies
            </div>
            <div class="filter-tab" onclick="filterCompanies('profitable')">
                <i class="fas fa-chart-line-up me-2"></i>Profitable
            </div>
            <div class="filter-tab" onclick="filterCompanies('positive-cash-flow')">
                <i class="fas fa-money-bill-trend-up me-2"></i>Positive Cash Flow
            </div>
            <div class="filter-tab" onclick="filterCompanies('needs-attention')">
                <i class="fas fa-exclamation-triangle me-2"></i>Needs Attention
            </div>
        </div>

        <!-- Error Message (Hidden by default) -->
        <div class="error-message" id="errorMessage" style="display: none;">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span id="errorText">Unable to load companies. Please try again.</span>
        </div>

        <!-- Loading State -->
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner"></div>
        </div>

        <!-- Companies Grid -->
        <div class="companies-grid" id="companiesGrid" style="display: none;">
            <!-- Companies will be loaded dynamically from cash_flow_statement table -->
        </div>

        <!-- Empty State -->
        <div class="empty-state" id="emptyState" style="display: none;">
            <i class="fas fa-building fa-4x mb-4"></i>
            <h4>No Companies Found</h4>
            <p>No companies match your search criteria. Try adjusting your filters or search terms.</p>
        </div>
    </div>

    <!-- Floating Add Button -->
    <button class="add-company-btn" onclick="addNewCompany()" title="Add New Company">
        <i class="fas fa-plus"></i>
    </button>

    {% endblock %}

{% block extra_js %}
<script>
        let allCompanies = [];
        let filteredCompanies = [];

        // ===== MAIN INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Loading Financial Risk Assessment Companies from Database...');
            loadCompaniesFromDatabase();
            
            // Add event listeners
            document.getElementById('searchCompanies').addEventListener('input', searchCompanies);
            document.getElementById('sortCompanies').addEventListener('change', sortCompanies);
        });

        // ===== FIXED DATABASE LOADING FUNCTIONS =====
        async function loadCompaniesFromDatabase() {
    try {
        showLoading(true);
        hideError();
        
        console.log('üì° Fetching companies from cash_flow_statement table...');
        
        const response = await fetch('/api/companies');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('üì• Raw API Response:', data);
        
        if (!data.success) {
            throw new Error(data.error || 'API returned error');
        }
        
        let companies = data.companies || [];
        
        if (companies.length === 0) {
            console.warn('‚ö†Ô∏è No companies found in cash_flow_statement table');
            showEmptyState();
            return;
        }
        
        console.log(`üìä Processing ${companies.length} companies from database...`);
        
        // Process company data with proper null handling
        allCompanies = companies.map((company, index) => {
            const processedCompany = {
                id: company.id || index + 1,
                name: company.company_name || company.name || `Company ${index + 1}`,
                
                // Financial metrics from cash_flow_statement table
                net_income: parseFloat(company.net_income || 0),
                operating_cash_flow: parseFloat(company.net_cash_from_operating_activities || company.operating_cash_flow || 0),
                investing_cash_flow: parseFloat(company.net_cash_from_investing_activities || 0),
                financing_cash_flow: parseFloat(company.net_cash_from_financing_activities || 0),
                free_cash_flow: parseFloat(company.free_cash_flow || 0),
                capital_expenditure: parseFloat(company.capital_expenditures || company.capital_expenditure || 0),
                
                // Additional fields
                revenue: parseFloat(company.revenue || 0),
                total_debt: parseFloat(company.total_debt || 0),
                
                // Metadata
                industry: company.industry || 'General',
                sector: company.sector || company.industry || 'Mixed',
                year: company.year || '2024'
            };
            
            // Calculate derived metrics
            processedCompany.financial_health_score = calculateHealthScore(processedCompany);
            processedCompany.cash_flow_status = getCashFlowStatus(processedCompany);
            processedCompany.profitability_status = getProfitabilityStatus(processedCompany);
            
            return processedCompany;
        });

        console.log(`‚úÖ Successfully processed ${allCompanies.length} companies`);
        console.log('üìä Sample processed company:', allCompanies[0]);
        
        filteredCompanies = [...allCompanies];
        renderCompanies(filteredCompanies);
        updateStatistics();
        
    } catch (error) {
        console.error('‚ùå Error loading companies from database:', error);
        showError(`Failed to load companies: ${error.message}`);
        showEmptyState();
    } finally {
        showLoading(false);
    }
}

        // ===== FINANCIAL CALCULATION FUNCTIONS =====
        function calculateHealthScore(company) {
            let score = 50; // Base score
            
            // Operating cash flow impact (40% weight)
            const ocf = company.operating_cash_flow || 0;
            if (ocf > 1000000) score += 20;
            else if (ocf > 0) score += 10;
            else if (ocf < -1000000) score -= 20;
            else score -= 10;
            
            // Net income impact (30% weight)
            const netIncome = company.net_income || 0;
            if (netIncome > 500000) score += 15;
            else if (netIncome > 0) score += 8;
            else if (netIncome < -500000) score -= 15;
            else score -= 8;
            
            // Free cash flow impact (30% weight)
            const fcf = company.free_cash_flow || 0;
            if (fcf > 500000) score += 15;
            else if (fcf > 0) score += 7;
            else if (fcf < -500000) score -= 15;
            else score -= 7;
            
            return Math.max(0, Math.min(100, Math.round(score)));
        }

        function getCashFlowStatus(company) {
            const ocf = company.operating_cash_flow || 0;
            if (ocf > 1000000) return 'excellent';
            if (ocf > 0) return 'good';
            if (ocf > -500000) return 'moderate';
            return 'poor';
        }

        function getProfitabilityStatus(company) {
            const netIncome = company.net_income || 0;
            if (netIncome > 500000) return 'excellent';
            if (netIncome > 0) return 'good';
            if (netIncome > -250000) return 'moderate';
            return 'poor';
        }

        // ===== RENDERING FUNCTIONS =====
        function renderCompanies(companies) {
            const grid = document.getElementById('companiesGrid');
            const emptyState = document.getElementById('emptyState');
            
            console.log(`üîÑ Rendering ${companies.length} companies...`);
            
            if (companies.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            grid.style.display = 'grid';
            emptyState.style.display = 'none';
            
            grid.innerHTML = companies.map(company => createCompanyCard(company)).join('');
        }

        function createCompanyCard(company) {
            const logo = company.name ? company.name.charAt(0).toUpperCase() : '?';
            const healthClass = getHealthClass(company.financial_health_score);
            const cashFlowClass = getStatusClass(company.cash_flow_status);
            const profitabilityClass = getStatusClass(company.profitability_status);
            
            return `
                <div class="company-card" data-company-id="${company.id}">
                    <div class="row">
                        <div class="col-auto">
                            <div class="company-logo">${logo}</div>
                        </div>
                        <div class="col">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h5 class="mb-1 fw-bold">${company.name}</h5>
                                    <small class="text-muted">${company.industry} ‚Ä¢ ${company.sector} ‚Ä¢ ${company.year}</small>
                                </div>
                                <div class="text-end">
                                    <div class="badge bg-primary">Score: ${company.financial_health_score}/100</div>
                                </div>
                            </div>
                            
                            <div class="row mb-2">
                                <div class="col-6">
                                    <div class="financial-status ${cashFlowClass}">
                                        <i class="fas fa-water"></i>
                                        Cash Flow: ${company.cash_flow_status.charAt(0).toUpperCase() + company.cash_flow_status.slice(1)}
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="financial-status ${profitabilityClass}">
                                        <i class="fas fa-chart-line"></i>
                                        Profitability: ${company.profitability_status.charAt(0).toUpperCase() + company.profitability_status.slice(1)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-3">
                            <div class="metric-badge">
                                <div>${formatCurrency(company.revenue)}</div>
                                <small>Revenue</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="metric-badge">
                                <div>${formatCurrency(company.net_income)}</div>
                                <small>Net Income</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="metric-badge">
                                <div>${formatCurrency(company.operating_cash_flow)}</div>
                                <small>Operating CF</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="metric-badge">
                                <div>${formatCurrency(company.free_cash_flow)}</div>
                                <small>Free CF</small>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col">
                            <button class="action-btn btn-view" onclick="viewCompanyDetails(${company.id})">
                                <i class="fas fa-eye me-1"></i>View Details
                            </button>
                            <button class="action-btn btn-analyze" onclick="analyzeCompany(${company.id})">
                                <i class="fas fa-calculator me-1"></i>Analyze Risk
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ===== UTILITY FUNCTIONS =====
        function getHealthClass(score) {
            if (score >= 80) return 'status-excellent';
            if (score >= 65) return 'status-good';
            if (score >= 40) return 'status-moderate';
            return 'status-poor';
        }

        function getStatusClass(status) {
            return `status-${status}`;
        }

        function formatCurrency(value) {
            if (!value || value === 0) return '0';
            
            const absValue = Math.abs(value);
            const sign = value < 0 ? '-' : '';
            
            if (absValue >= 1e12) return `${sign}${(absValue/1e12).toFixed(1)}T`;
            if (absValue >= 1e9) return `${sign}${(absValue/1e9).toFixed(1)}B`;
            if (absValue >= 1e6) return `${sign}${(absValue/1e6).toFixed(1)}M`;
            if (absValue >= 1e3) return `${sign}${(absValue/1e3).toFixed(1)}K`;
            return `${sign}${absValue.toFixed(0)}`;
        }

        function updateStatistics() {
            const total = allCompanies.length;
            const healthy = allCompanies.filter(c => c.financial_health_score >= 70).length;
            const atRisk = allCompanies.filter(c => c.financial_health_score < 40).length;
            const avgScore = total > 0 ? (allCompanies.reduce((sum, c) => sum + c.financial_health_score, 0) / total).toFixed(1) : '0.0';
            
            document.getElementById('totalCompanies').textContent = total;
            document.getElementById('healthyCompanies').textContent = healthy;
            document.getElementById('riskCompanies').textContent = atRisk;
            document.getElementById('avgHealthScore').textContent = avgScore;
        }

        // ===== SEARCH AND FILTER FUNCTIONS =====
        function searchCompanies() {
            const searchTerm = document.getElementById('searchCompanies').value.toLowerCase();
            
            if (!searchTerm.trim()) {
                filteredCompanies = [...allCompanies];
            } else {
                filteredCompanies = allCompanies.filter(company => 
                    company.name.toLowerCase().includes(searchTerm) ||
                    company.industry.toLowerCase().includes(searchTerm) ||
                    company.sector.toLowerCase().includes(searchTerm) ||
                    company.cash_flow_status.toLowerCase().includes(searchTerm) ||
                    company.profitability_status.toLowerCase().includes(searchTerm)
                );
            }
            
            renderCompanies(filteredCompanies);
        }

        function sortCompanies() {
            const sortBy = document.getElementById('sortCompanies').value;
            
            filteredCompanies.sort((a, b) => {
                switch (sortBy) {
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'cash_flow':
                        return b.operating_cash_flow - a.operating_cash_flow;
                    case 'net_income':
                        return b.net_income - a.net_income;
                    case 'revenue':
                        return b.revenue - a.revenue;
                    default:
                        return 0;
                }
            });
            
            renderCompanies(filteredCompanies);
        }

        function filterCompanies(filter) {
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            console.log(`üîç Filtering companies by: ${filter}`);

            switch (filter) {
                case 'all':
                    filteredCompanies = [...allCompanies];
                    break;
                case 'profitable':
                    filteredCompanies = allCompanies.filter(c => c.net_income > 0);
                    break;
                case 'positive-cash-flow':
                    filteredCompanies = allCompanies.filter(c => c.operating_cash_flow > 0);
                    break;
                case 'needs-attention':
                    filteredCompanies = allCompanies.filter(c => 
                        c.financial_health_score < 40 || 
                        (c.net_income < 0 && c.operating_cash_flow < 0)
                    );
                    break;
                default:
                    filteredCompanies = [...allCompanies];
            }

            console.log(`üìä Filtered to ${filteredCompanies.length} companies`);
            renderCompanies(filteredCompanies);
        }

        // ===== COMPANY ACTION FUNCTIONS =====
        function viewCompanyDetails(companyId) {
            const company = allCompanies.find(c => c.id === companyId);
            if (!company) {
                showError('Company not found');
                return;
            }
            
            console.log(`üëÅÔ∏è Viewing details for: ${company.name}`);
            showCompanyDetailsModal(company);
        }

        function analyzeCompany(companyId) {
            const company = allCompanies.find(c => c.id === companyId);
            if (!company) {
                showError('Company not found');
                return;
            }
            
            console.log(`üîç Analyzing financial risk for: ${company.name}`);
            performRiskAnalysis(company);
        }

        function showCompanyDetailsModal(company) {
            const modalHtml = `
                <div class="modal fade" id="companyDetailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content" style="border-radius: 20px;">
                            <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-color) 0%, #1e40af 100%); color: white; border-radius: 20px 20px 0 0;">
                                <h5 class="modal-title">
                                    <i class="fas fa-building me-2"></i>
                                    ${company.name} - Financial Overview
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body p-4">
                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <div class="card h-100">
                                            <div class="card-header bg-primary text-white">
                                                <h6><i class="fas fa-info-circle me-2"></i>Company Information</h6>
                                            </div>
                                            <div class="card-body">
                                                <p><strong>Industry:</strong> ${company.industry}</p>
                                                <p><strong>Sector:</strong> ${company.sector}</p>
                                                <p><strong>Year:</strong> ${company.year}</p>
                                                <p><strong>Financial Health Score:</strong> 
                                                    <span class="badge bg-${getScoreBadgeClass(company.financial_health_score)}">${company.financial_health_score}/100</span>
                                                </p>
                                                <p><strong>Cash Flow Status:</strong> 
                                                    <span class="badge bg-${getStatusBadgeClass(company.cash_flow_status)}">${company.cash_flow_status.charAt(0).toUpperCase() + company.cash_flow_status.slice(1)}</span>
                                                </p>
                                                <p><strong>Profitability Status:</strong> 
                                                    <span class="badge bg-${getStatusBadgeClass(company.profitability_status)}">${company.profitability_status.charAt(0).toUpperCase() + company.profitability_status.slice(1)}</span>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card h-100">
                                            <div class="card-header bg-success text-white">
                                                <h6><i class="fas fa-chart-line me-2"></i>Financial Metrics</h6>
                                            </div>
                                            <div class="card-body">
                                                <p><strong>Revenue:</strong> ${formatDetailedCurrency(company.revenue)}</p>
                                                <p><strong>Net Income:</strong> ${formatDetailedCurrency(company.net_income)}</p>
                                                <p><strong>Operating Cash Flow:</strong> ${formatDetailedCurrency(company.operating_cash_flow)}</p>
                                                <p><strong>Free Cash Flow:</strong> ${formatDetailedCurrency(company.free_cash_flow)}</p>
                                                <p><strong>Capital Expenditure:</strong> ${formatDetailedCurrency(company.capital_expenditure)}</p>
                                                <p><strong>Total Debt:</strong> ${formatDetailedCurrency(company.total_debt)}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row g-4 mt-1">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header bg-info text-white">
                                                <h6><i class="fas fa-lightbulb me-2"></i>Financial Analysis</h6>
                                            </div>
                                            <div class="card-body">
                                                ${generateFinancialAnalysis(company)}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" onclick="analyzeCompany(${company.id})">
                                    <i class="fas fa-calculator me-2"></i>Perform Risk Analysis
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('companyDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('companyDetailsModal'));
            modal.show();
        }

        function performRiskAnalysis(company) {
            console.log(`ü§ñ Performing ML-powered risk analysis for ${company.name}...`);
            
            // Calculate risk factors
            const riskFactors = calculateRiskFactors(company);
            const recommendations = generateRecommendations(company, riskFactors);
            
            // Show risk analysis modal
            showRiskAnalysisModal(company, riskFactors, recommendations);
        }

        function calculateRiskFactors(company) {
            const factors = {
                liquidity_risk: 0,
                profitability_risk: 0,
                cash_flow_risk: 0,
                overall_risk: 0
            };
            
            // Liquidity Risk Assessment
            if (company.operating_cash_flow < 0) factors.liquidity_risk += 30;
            if (company.free_cash_flow < 0) factors.liquidity_risk += 25;
            if (company.net_income < 0 && company.operating_cash_flow < 0) factors.liquidity_risk += 25;
            
            // Profitability Risk Assessment
            if (company.net_income < 0) factors.profitability_risk += 40;
            if (company.revenue === 0) factors.profitability_risk += 30;
            if (company.net_income < company.revenue * 0.05) factors.profitability_risk += 20; // Low profit margin
            
            // Cash Flow Risk Assessment
            if (company.operating_cash_flow < company.capital_expenditure) factors.cash_flow_risk += 30;
            if (company.free_cash_flow < 0) factors.cash_flow_risk += 35;
            if (Math.abs(company.operating_cash_flow) < Math.abs(company.net_income) * 0.8) factors.cash_flow_risk += 25;
            
            // Overall Risk (weighted average)
            factors.overall_risk = Math.round(
                (factors.liquidity_risk * 0.4 + 
                 factors.profitability_risk * 0.35 + 
                 factors.cash_flow_risk * 0.25)
            );
            
            return factors;
        }

        function generateRecommendations(company, riskFactors) {
            const recommendations = [];
            
            if (riskFactors.liquidity_risk > 50) {
                recommendations.push({
                    type: 'danger',
                    icon: 'fa-exclamation-triangle',
                    title: 'Critical Liquidity Risk',
                    description: 'Immediate action required to improve cash position. Consider emergency funding or cost reduction measures.'
                });
            }
            
            if (riskFactors.profitability_risk > 40) {
                recommendations.push({
                    type: 'warning',
                    icon: 'fa-chart-line-down',
                    title: 'Profitability Concerns',
                    description: 'Focus on revenue optimization and cost management to improve profit margins.'
                });
            }
            
            if (riskFactors.cash_flow_risk > 40) {
                recommendations.push({
                    type: 'info',
                    icon: 'fa-water',
                    title: 'Cash Flow Management',
                    description: 'Implement better cash flow forecasting and working capital management strategies.'
                });
            }
            
            if (company.financial_health_score > 70) {
                recommendations.push({
                    type: 'success',
                    icon: 'fa-check-circle',
                    title: 'Strong Financial Position',
                    description: 'Continue current strategies and consider growth opportunities or dividend distributions.'
                });
            }
            
            return recommendations;
        }

        function showRiskAnalysisModal(company, riskFactors, recommendations) {
            const modalHtml = `
                <div class="modal fade" id="riskAnalysisModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content" style="border-radius: 20px;">
                            <div class="modal-header" style="background: linear-gradient(135deg, var(--warning-color) 0%, #d97706 100%); color: white; border-radius: 20px 20px 0 0;">
                                <h5 class="modal-title">
                                    <i class="fas fa-shield-alt me-2"></i>
                                    ${company.name} - Risk Analysis Report
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body p-4">
                                <div class="row g-4">
                                    <div class="col-md-8">
                                        <div class="card">
                                            <div class="card-header bg-primary text-white">
                                                <h6><i class="fas fa-chart-bar me-2"></i>Risk Assessment Breakdown</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label class="form-label"><strong>Liquidity Risk</strong></label>
                                                    <div class="progress mb-1">
                                                        <div class="progress-bar ${getRiskProgressClass(riskFactors.liquidity_risk)}" 
                                                             style="width: ${riskFactors.liquidity_risk}%">
                                                            ${riskFactors.liquidity_risk}%
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label"><strong>Profitability Risk</strong></label>
                                                    <div class="progress mb-1">
                                                        <div class="progress-bar ${getRiskProgressClass(riskFactors.profitability_risk)}" 
                                                             style="width: ${riskFactors.profitability_risk}%">
                                                            ${riskFactors.profitability_risk}%
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label"><strong>Cash Flow Risk</strong></label>
                                                    <div class="progress mb-1">
                                                        <div class="progress-bar ${getRiskProgressClass(riskFactors.cash_flow_risk)}" 
                                                             style="width: ${riskFactors.cash_flow_risk}%">
                                                            ${riskFactors.cash_flow_risk}%
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label"><strong>Overall Risk Score</strong></label>
                                                    <div class="progress mb-1">
                                                        <div class="progress-bar ${getRiskProgressClass(riskFactors.overall_risk)}" 
                                                             style="width: ${riskFactors.overall_risk}%">
                                                            ${riskFactors.overall_risk}%
                                                        </div>
                                                    </div>
                                                    <small class="text-muted">Overall Risk Level: ${getRiskLevel(riskFactors.overall_risk)}</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-header bg-info text-white">
                                                <h6><i class="fas fa-info-circle me-2"></i>Quick Stats</h6>
                                            </div>
                                            <div class="card-body">
                                                <p><strong>Health Score:</strong> ${company.financial_health_score}/100</p>
                                                <p><strong>Cash Flow Status:</strong> ${company.cash_flow_status}</p>
                                                <p><strong>Profit Status:</strong> ${company.profitability_status}</p>
                                                <p><strong>Analysis Date:</strong> ${new Date().toLocaleDateString()}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row g-4 mt-1">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header bg-warning text-dark">
                                                <h6><i class="fas fa-lightbulb me-2"></i>ML-Powered Recommendations</h6>
                                            </div>
                                            <div class="card-body">
                                                ${recommendations.map(rec => `
                                                    <div class="alert alert-${rec.type} d-flex align-items-center mb-3">
                                                        <i class="fas ${rec.icon} me-3"></i>
                                                        <div>
                                                            <strong>${rec.title}</strong><br>
                                                            ${rec.description}
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" onclick="downloadRiskReport(${company.id})">
                                    <i class="fas fa-download me-2"></i>Download Report
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('riskAnalysisModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('riskAnalysisModal'));
            modal.show();
        }

        // ===== HELPER FUNCTIONS =====
        function getScoreBadgeClass(score) {
            if (score >= 80) return 'success';
            if (score >= 65) return 'info';
            if (score >= 40) return 'warning';
            return 'danger';
        }

        function getStatusBadgeClass(status) {
            const statusMap = {
                'excellent': 'success',
                'good': 'info',
                'moderate': 'warning',
                'poor': 'danger'
            };
            return statusMap[status] || 'secondary';
        }

        function getRiskProgressClass(risk) {
            if (risk < 25) return 'bg-success';
            if (risk < 50) return 'bg-warning';
            return 'bg-danger';
        }

        function getRiskLevel(risk) {
            if (risk < 25) return 'Low Risk';
            if (risk < 50) return 'Moderate Risk';
            if (risk < 75) return 'High Risk';
            return 'Critical Risk';
        }

        function formatDetailedCurrency(value) {
            if (!value || value === 0) return '$0';
            
            const absValue = Math.abs(value);
            const sign = value < 0 ? '-$' : '$';
            
            if (absValue >= 1e12) return `${sign}${(absValue/1e12).toFixed(2)} Trillion`;
            if (absValue >= 1e9) return `${sign}${(absValue/1e9).toFixed(2)} Billion`;
            if (absValue >= 1e6) return `${sign}${(absValue/1e6).toFixed(2)} Million`;
            if (absValue >= 1e3) return `${sign}${(absValue/1e3).toFixed(2)} Thousand`;
            return `${sign}${absValue.toLocaleString()}`;
        }

        function generateFinancialAnalysis(company) {
            let analysis = [];
            
            // Cash flow analysis
            if (company.operating_cash_flow > 0) {
                analysis.push(`‚úÖ <strong>Positive Operating Cash Flow:</strong> The company generates ${formatDetailedCurrency(company.operating_cash_flow)} from operations, indicating healthy business operations.`);
            } else {
                analysis.push(`‚ö†Ô∏è <strong>Negative Operating Cash Flow:</strong> The company has negative cash flow of ${formatDetailedCurrency(company.operating_cash_flow)}, which requires immediate attention.`);
            }
            
            // Profitability analysis
            if (company.net_income > 0) {
                analysis.push(`‚úÖ <strong>Profitable Operations:</strong> Net income of ${formatDetailedCurrency(company.net_income)} shows the company is generating profits.`);
            } else {
                analysis.push(`‚ö†Ô∏è <strong>Operating at a Loss:</strong> Net loss of ${formatDetailedCurrency(Math.abs(company.net_income))} indicates profitability challenges.`);
            }
            
            // Free cash flow analysis
            if (company.free_cash_flow > 0) {
                analysis.push(`‚úÖ <strong>Strong Free Cash Flow:</strong> ${formatDetailedCurrency(company.free_cash_flow)} available for growth, debt repayment, or shareholder returns.`);
            } else {
                analysis.push(`‚ö†Ô∏è <strong>Negative Free Cash Flow:</strong> The company is spending more on capital expenditures than it generates from operations.`);
            }
            
            // Overall health assessment
            if (company.financial_health_score >= 70) {
                analysis.push(`üéØ <strong>Overall Assessment:</strong> With a health score of ${company.financial_health_score}/100, this company shows strong financial fundamentals.`);
            } else if (company.financial_health_score >= 40) {
                analysis.push(`‚öñÔ∏è <strong>Overall Assessment:</strong> The health score of ${company.financial_health_score}/100 indicates moderate financial health with room for improvement.`);
            } else {
                analysis.push(`üö® <strong>Overall Assessment:</strong> A health score of ${company.financial_health_score}/100 suggests significant financial challenges requiring immediate attention.`);
            }
            
            return analysis.join('<br><br>');
        }

        // ===== ADDITIONAL FUNCTIONS =====
        function addNewCompany() {
            console.log('‚ûï Adding new company to cash flow analysis...');
            alert('This feature will allow you to add new companies to your cash flow statement database for analysis.');
        }

        function downloadRiskReport(companyId) {
            const company = allCompanies.find(c => c.id === companyId);
            if (!company) return;
            
            console.log(`üìÑ Downloading risk report for ${company.name}...`);
            alert(`Risk analysis report for ${company.name} will be generated and downloaded.`);
        }

        function exportPortfolioData() {
            console.log('üì• Exporting portfolio data...');
            alert('Portfolio data export will include all companies from your cash flow statement database.');
        }

        function showPortfolioAnalytics() {
            console.log('üìä Opening portfolio analytics...');
            window.location.href = '/analysis?view=portfolio';
        }

        // ===== UI HELPER FUNCTIONS =====
        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'flex' : 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorDiv.style.display = 'block';
            console.error('üî¥ Error:', message);
            
            setTimeout(hideError, 5000);
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        function showEmptyState() {
            document.getElementById('companiesGrid').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
        }

        // ===== DEBUG INFO =====
        console.log('üè¢ Enhanced Company Management System Initialized');
        console.log('üìä Data Source: Multiple API endpoints with fallback');
        console.log('ü§ñ ML-Powered Financial Analysis Ready');
        console.log('üí∞ Real-time Financial Health Scoring Active');
        console.log('üîß Enhanced Error Handling & Data Format Support');
    </script>
{% endblock %}